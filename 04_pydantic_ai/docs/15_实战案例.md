# Pydantic AI å®æˆ˜æ¡ˆä¾‹

> æœ¬æ–‡æ¡£é€šè¿‡å®Œæ•´çš„å®æˆ˜æ¡ˆä¾‹ï¼Œå±•ç¤ºå¦‚ä½•æ„å»ºç”Ÿäº§çº§ Agent åº”ç”¨ã€‚

## ğŸ“‹ ç›®å½•

- [æ¡ˆä¾‹1ï¼šæ™ºèƒ½å®¢æœæœºå™¨äºº](#æ¡ˆä¾‹1æ™ºèƒ½å®¢æœæœºå™¨äºº)
- [æ¡ˆä¾‹2ï¼šä»£ç å®¡æŸ¥åŠ©æ‰‹](#æ¡ˆä¾‹2ä»£ç å®¡æŸ¥åŠ©æ‰‹)
- [æ¡ˆä¾‹3ï¼šæ•°æ®åˆ†æ Agent](#æ¡ˆä¾‹3æ•°æ®åˆ†æ-agent)

## æ¡ˆä¾‹1ï¼šæ™ºèƒ½å®¢æœæœºå™¨äºº

### éœ€æ±‚åˆ†æ

æ„å»ºä¸€ä¸ªå®¢æœæœºå™¨äººï¼Œèƒ½å¤Ÿï¼š
- å›ç­”å¸¸è§é—®é¢˜
- æŸ¥è¯¢è®¢å•çŠ¶æ€
- å¤„ç†é€€æ¬¾ç”³è¯·
- å‡çº§åˆ°äººå·¥å®¢æœ

### å®ç°

```python
from pydantic_ai import Agent, RunContext
from pydantic import BaseModel
from dataclasses import dataclass
from typing import Literal

# å®šä¹‰ä¾èµ–
@dataclass
class CustomerServiceDeps:
    db_connection: Database
    user_id: str

# å®šä¹‰è¾“å‡ºç±»å‹
class CustomerResponse(BaseModel):
    message: str
    action: Literal['answer', 'escalate', 'refund'] | None = None
    order_id: str | None = None

# åˆ›å»º Agent
agent = Agent(
    'openai:gpt-4',
    deps_type=CustomerServiceDeps,
    output_type=CustomerResponse,
    system_prompt='''
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœä»£è¡¨ã€‚
èŒè´£ï¼š
1. å‹å¥½åœ°å›ç­”ç”¨æˆ·é—®é¢˜
2. æŸ¥è¯¢è®¢å•ä¿¡æ¯
3. å¤„ç†é€€æ¬¾ç”³è¯·ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
4. å¤æ‚é—®é¢˜å‡çº§åˆ°äººå·¥
'''
)

# æ·»åŠ å·¥å…·
@agent.tool
async defæŸ¥è¯¢è®¢å•(ctx: RunContext[CustomerServiceDeps], order_id: str) -> dict:
    """æŸ¥è¯¢è®¢å•çŠ¶æ€"""
    order = await ctx.deps.db_connection.query(
        'SELECT * FROM orders WHERE id = ?', order_id
    )
    return order

@agent.tool
async defç”³è¯·é€€æ¬¾(ctx: RunContext[CustomerServiceDeps], order_id: str) -> str:
    """ç”³è¯·é€€æ¬¾ï¼ˆéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰"""
    # äººæœºäº¤äº’ï¼šç¡®è®¤
    print(f"å³å°†ä¸ºè®¢å• {order_id} ç”³è¯·é€€æ¬¾")
    confirmed = input("ç¡®è®¤é€€æ¬¾? (y/n): ")

    if confirmed.lower() != 'y':
        return "é€€æ¬¾å·²å–æ¶ˆ"

    # å¤„ç†é€€æ¬¾
    await ctx.deps.db_connection.execute(
        'UPDATE orders SET status = ? WHERE id = ?',
        ('refunding', order_id)
    )
    return f"é€€æ¬¾ç”³è¯·å·²æäº¤ï¼Œè®¢å•å·ï¼š{order_id}"

# ä½¿ç”¨
async def handle_customer_inquiry(user_id: str, message: str):
    deps = CustomerServiceDeps(
        db_connection=get_db(),
        user_id=user_id
    )

    result = await agent.run(message, deps=deps)

    if result.data.action == 'escalate':
        # å‡çº§åˆ°äººå·¥
        await notify_human_agent(user_id, message)

    return result.data.message
```

## æ¡ˆä¾‹2ï¼šä»£ç å®¡æŸ¥åŠ©æ‰‹

### éœ€æ±‚åˆ†æ

è‡ªåŠ¨å®¡æŸ¥ä»£ç ï¼Œæ£€æŸ¥ï¼š
- ä»£ç è´¨é‡
- æ½œåœ¨ bug
- å®‰å…¨æ¼æ´
- æœ€ä½³å®è·µè¿å

### å®ç°

```python
class CodeIssue(BaseModel):
    file: str
    line: int
    severity: Literal['low', 'medium', 'high', 'critical']
    message: str
    suggestion: str

class CodeReview(BaseModel):
    summary: str
    issues: list[CodeIssue]
    score: float = Field(ge=0, le=10)

agent = Agent(
    'openai:gpt-4',
    output_type=CodeReview,
    system_prompt='''
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥å‘˜ã€‚
æ£€æŸ¥ï¼š
1. ä»£ç è´¨é‡å’Œå¯è¯»æ€§
2. æ½œåœ¨çš„ bug
3. å®‰å…¨æ¼æ´ï¼ˆSQLæ³¨å…¥ã€XSSç­‰ï¼‰
4. æ€§èƒ½é—®é¢˜
5. æœ€ä½³å®è·µ
'''
)

# ä½¿ç”¨
async def review_code(code: str, filename: str) -> CodeReview:
    prompt = f'''
å®¡æŸ¥ä»¥ä¸‹ä»£ç ï¼š

æ–‡ä»¶ï¼š{filename}
```python
{code}
```
'''

    result = await agent.run(prompt)
    return result.data

# ç¤ºä¾‹
code = '''
def get_user(user_id):
    query = f"SELECT * FROM users WHERE id = {user_id}"
    return execute_query(query)
'''

review = await review_code(code, 'user.py')
print(f"è¯„åˆ†ï¼š{review.score}/10")
for issue in review.issues:
    print(f"[{issue.severity}] {issue.file}:{issue.line}")
    print(f"  é—®é¢˜ï¼š{issue.message}")
    print(f"  å»ºè®®ï¼š{issue.suggestion}")
```

## æ¡ˆä¾‹3ï¼šæ•°æ®åˆ†æ Agent

### éœ€æ±‚åˆ†æ

åˆ†ææ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Šï¼š
- è‡ªåŠ¨æ•°æ®æ¸…æ´—
- ç»Ÿè®¡åˆ†æ
- ç”Ÿæˆå¯è§†åŒ–
- ç¼–å†™åˆ†ææŠ¥å‘Š

### å®ç°

```python
import pandas as pd
import matplotlib.pyplot as plt

@dataclass
class AnalysisDeps:
    data: pd.DataFrame

class AnalysisReport(BaseModel):
    summary: str
    key_findings: list[str]
    visualizations: list[str]  # å›¾è¡¨è·¯å¾„
    recommendations: list[str]

agent = Agent(
    'openai:gpt-4',
    deps_type=AnalysisDeps,
    output_type=AnalysisReport
)

@agent.tool
defç»Ÿè®¡æ‘˜è¦(ctx: RunContext[AnalysisDeps]) -> dict:
    """ç”Ÿæˆæ•°æ®ç»Ÿè®¡æ‘˜è¦"""
    return ctx.deps.data.describe().to_dict()

@agent.tool
defåˆ›å»ºå¯è§†åŒ–(
    ctx: RunContext[AnalysisDeps],
    chart_type: str,
    x_column: str,
    y_column: str
) -> str:
    """åˆ›å»ºå¯è§†åŒ–å›¾è¡¨"""
    plt.figure(figsize=(10, 6))

    if chart_type == 'bar':
        ctx.deps.data.plot.bar(x=x_column, y=y_column)
    elif chart_type == 'line':
        ctx.deps.data.plot.line(x=x_column, y=y_column)

    filepath = f'chart_{x_column}_{y_column}.png'
    plt.savefig(filepath)
    plt.close()

    return filepath

# ä½¿ç”¨
async def analyze_data(df: pd.DataFrame):
    deps = AnalysisDeps(data=df)

    result = await agent.run(
        'è¯·åˆ†æè¿™ä»½é”€å”®æ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Š',
        deps=deps
    )

    return result.data
```

## ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“

### 1. æ¨¡å—åŒ–è®¾è®¡
- Agent èŒè´£å•ä¸€
- å·¥å…·å¤ç”¨
- ä¾èµ–æ³¨å…¥

### 2. é”™è¯¯å¤„ç†
- ä¼˜é›…é™çº§
- é‡è¯•æœºåˆ¶
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

### 3. å¯è§‚æµ‹æ€§
- é›†æˆ Logfire
- è®°å½•å…³é”®æ“ä½œ
- ç›‘æ§æ€§èƒ½å’Œæˆæœ¬

### 4. æµ‹è¯•
- å•å…ƒæµ‹è¯•å·¥å…·
- é›†æˆæµ‹è¯•æµç¨‹
- è¯„ä¼°è¾“å‡ºè´¨é‡

## ğŸ“š å®Œæ•´é¡¹ç›®å‚è€ƒ

æŸ¥çœ‹ GitHub ä¸Šçš„å®Œæ•´ç¤ºä¾‹é¡¹ç›®ï¼š
- [å®˜æ–¹ç¤ºä¾‹](https://github.com/pydantic/pydantic-ai/tree/main/examples)

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [14_æœ€ä½³å®è·µ.md](./14_æœ€ä½³å®è·µ.md)
- [13_æµ‹è¯•ä¸è¯„ä¼°.md](./13_æµ‹è¯•ä¸è¯„ä¼°.md)
- [12_å¯è§‚æµ‹æ€§.md](./12_å¯è§‚æµ‹æ€§.md)
