# Pydantic AI ç»“æ„åŒ–è¾“å‡º

> æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Pydantic æ¨¡å‹å®šä¹‰å’ŒéªŒè¯ LLM è¾“å‡ºï¼Œç¡®ä¿æ•°æ®çš„ç±»å‹å®‰å…¨å’Œæ­£ç¡®æ€§ã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ç»“æ„åŒ–è¾“å‡ºï¼Ÿ

### é—®é¢˜ï¼šçº¯æ–‡æœ¬è¾“å‡ºçš„å±€é™æ€§

```python
# âŒ çº¯æ–‡æœ¬è¾“å‡º
agent = Agent('openai:gpt-4')
result = agent.run_sync('åŒ—äº¬çš„äººå£æ˜¯å¤šå°‘ï¼Ÿ')
print(result.data)
# è¾“å‡ºï¼š"åŒ—äº¬å¸‚å¸¸ä½äººå£çº¦ä¸º2189ä¸‡äººï¼ˆ2023å¹´æ•°æ®ï¼‰"

# é—®é¢˜ï¼š
# 1. éœ€è¦æ‰‹åŠ¨è§£ææ–‡æœ¬
# 2. æ ¼å¼ä¸ç»Ÿä¸€
# 3. éš¾ä»¥æå–å…·ä½“æ•°å€¼
# 4. å®¹æ˜“å‡ºé”™
```

### è§£å†³æ–¹æ¡ˆï¼šç»“æ„åŒ–è¾“å‡º

```python
from pydantic import BaseModel

class CityPopulation(BaseModel):
    city: str
    population: int
    year: int

agent = Agent('openai:gpt-4', output_type=CityPopulation)
result = agent.run_sync('åŒ—äº¬çš„äººå£æ˜¯å¤šå°‘ï¼Ÿ')

# âœ… ç±»å‹å®‰å…¨çš„ç»“æ„åŒ–æ•°æ®
print(result.data.city)        # "åŒ—äº¬"
print(result.data.population)  # 21890000
print(result.data.year)        # 2023
```

## ğŸ“ å®šä¹‰è¾“å‡ºæ¨¡å‹

### åŸºç¡€æ¨¡å‹

```python
from pydantic import BaseModel, Field

class Product(BaseModel):
    """äº§å“ä¿¡æ¯"""
    name: str = Field(description="äº§å“åç§°")
    price: float = Field(description="ä»·æ ¼", gt=0)
    in_stock: bool = Field(description="æ˜¯å¦æœ‰è´§")
    tags: list[str] = Field(description="æ ‡ç­¾åˆ—è¡¨", default_factory=list)

agent = Agent('openai:gpt-4', output_type=Product)
```

### åµŒå¥—æ¨¡å‹

```python
from typing import Optional

class Address(BaseModel):
    """åœ°å€"""
    street: str
    city: str
    country: str
    postal_code: Optional[str] = None

class Person(BaseModel):
    """äººå‘˜ä¿¡æ¯"""
    name: str
    age: int = Field(ge=0, le=150)
    email: str
    address: Address  # åµŒå¥—æ¨¡å‹
    friends: list[str] = []

agent = Agent('openai:gpt-4', output_type=Person)
```

### å¤æ‚æ•°æ®ç»“æ„

```python
from enum import Enum
from datetime import datetime

class Priority(str, Enum):
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"

class Task(BaseModel):
    title: str
    description: str
    priority: Priority  # æšä¸¾
    due_date: datetime  # æ—¥æœŸæ—¶é—´
    tags: set[str] = set()  # é›†åˆ
    metadata: dict[str, str] = {}  # å­—å…¸

agent = Agent('openai:gpt-4', output_type=Task)
```

## âœ… è¾“å‡ºéªŒè¯

### è‡ªåŠ¨éªŒè¯

```python
class Email(BaseModel):
    recipient: str = Field(pattern=r'^[\w\.-]+@[\w\.-]+\.\w+$')
    subject: str = Field(min_length=1, max_length=200)
    body: str

# Pydantic è‡ªåŠ¨éªŒè¯
# - recipient å¿…é¡»æ˜¯æœ‰æ•ˆé‚®ç®±æ ¼å¼
# - subject é•¿åº¦ 1-200 å­—ç¬¦
# - body å¿…é¡»æ˜¯å­—ç¬¦ä¸²
```

### è‡ªå®šä¹‰éªŒè¯å™¨

```python
from pydantic import field_validator, model_validator

class UserRegistration(BaseModel):
    username: str
    password: str
    confirm_password: str
    age: int

    @field_validator('username')
    def validate_username(cls, v):
        if len(v) < 3:
            raise ValueError('ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦')
        if not v.isalnum():
            raise ValueError('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—')
        return v

    @field_validator('age')
    def validate_age(cls, v):
        if v < 18:
            raise ValueError('å¿…é¡»å¹´æ»¡18å²')
        return v

    @model_validator(mode='after')
    def validate_passwords(self):
        if self.password != self.confirm_password:
            raise ValueError('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´')
        return self
```

### ä½¿ç”¨è¾“å‡ºéªŒè¯å™¨

```python
from pydantic_ai import Agent, RunContext, ModelRetry

class ProductInfo(BaseModel):
    name: str
    price: float
    stock: int

agent = Agent('openai:gpt-4', output_type=ProductInfo)

@agent.output_validator
def validate_product(ctx: RunContext[None], output: ProductInfo) -> ProductInfo:
    """éªŒè¯äº§å“ä¿¡æ¯çš„åˆç†æ€§"""
    # ä»·æ ¼æ£€æŸ¥
    if output.price <= 0:
        raise ModelRetry('ä»·æ ¼å¿…é¡»å¤§äº0ï¼Œè¯·é‡æ–°ç”Ÿæˆ')

    # åº“å­˜æ£€æŸ¥
    if output.stock < 0:
        raise ModelRetry('åº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œè¯·é‡æ–°ç”Ÿæˆ')

    # åç§°æ£€æŸ¥
    if len(output.name) < 2:
        raise ModelRetry('äº§å“åç§°å¤ªçŸ­ï¼Œè¯·æä¾›å®Œæ•´åç§°')

    return output
```

## ğŸ“Š å¤šç§è¾“å‡ºç±»å‹

### åˆ—è¡¨è¾“å‡º

```python
class Article(BaseModel):
    title: str
    summary: str
    url: str

# è¿”å›æ–‡ç« åˆ—è¡¨
agent = Agent('openai:gpt-4', output_type=list[Article])

result = agent.run_sync('æœç´¢æœ€æ–°çš„AIæ–°é—»ï¼Œè¿”å›3ç¯‡æ–‡ç« ')
for article in result.data:
    print(f"{article.title}: {article.url}")
```

### å­—å…¸è¾“å‡º

```python
# è¿”å›å­—å…¸
agent = Agent('openai:gpt-4', output_type=dict[str, int])

result = agent.run_sync('ç»Ÿè®¡æ–‡æœ¬ä¸­å„å•è¯å‡ºç°æ¬¡æ•°ï¼š"hello world hello"')
print(result.data)  # {"hello": 2, "world": 1}
```

### è”åˆç±»å‹

```python
from typing import Union

class SuccessResponse(BaseModel):
    status: str = "success"
    data: dict

class ErrorResponse(BaseModel):
    status: str = "error"
    error_message: str

# å¯èƒ½è¿”å›æˆåŠŸæˆ–é”™è¯¯
agent = Agent(
    'openai:gpt-4',
    output_type=Union[SuccessResponse, ErrorResponse]
)
```

## ğŸ¨ å®é™…åº”ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å†è§£æ

```python
from typing import Optional

class Education(BaseModel):
    school: str
    degree: str
    major: str
    year: int

class WorkExperience(BaseModel):
    company: str
    position: str
    start_year: int
    end_year: Optional[int] = None
    description: str

class Resume(BaseModel):
    name: str
    email: str
    phone: str
    education: list[Education]
    work_experience: list[WorkExperience]
    skills: list[str]

agent = Agent('openai:gpt-4', output_type=Resume)

resume_text = """
å¼ ä¸‰ï¼Œé‚®ç®±ï¼šzhangsan@example.comï¼Œç”µè¯ï¼š138xxxx
æ•™è‚²èƒŒæ™¯ï¼šæ¸…åå¤§å­¦ï¼Œè®¡ç®—æœºç§‘å­¦å­¦å£«ï¼Œ2015-2019
å·¥ä½œç»å†ï¼š
- å­—èŠ‚è·³åŠ¨ï¼Œåç«¯å·¥ç¨‹å¸ˆï¼Œ2019-2022ï¼Œè´Ÿè´£æ¨èç³»ç»Ÿå¼€å‘
- é˜¿é‡Œå·´å·´ï¼Œé«˜çº§å·¥ç¨‹å¸ˆï¼Œ2022-è‡³ä»Šï¼Œè´Ÿè´£äº‘å¹³å°æ¶æ„
æŠ€èƒ½ï¼šPython, Go, Kubernetes, å¾®æœåŠ¡æ¶æ„
"""

result = agent.run_sync(f'è§£æä»¥ä¸‹ç®€å†ï¼š\n{resume_text}')
resume = result.data

print(f"å§“åï¼š{resume.name}")
print(f"é‚®ç®±ï¼š{resume.email}")
print(f"æŠ€èƒ½ï¼š{', '.join(resume.skills)}")
```

### ç¤ºä¾‹ 2: æƒ…æ„Ÿåˆ†æ

```python
class SentimentAnalysis(BaseModel):
    text: str
    sentiment: str = Field(description="positive, negative, or neutral")
    score: float = Field(ge=0.0, le=1.0, description="ç½®ä¿¡åº¦")
    aspects: dict[str, str] = Field(
        description="å„æ–¹é¢çš„æƒ…æ„Ÿï¼Œå¦‚ {'æœåŠ¡': 'positive', 'ä»·æ ¼': 'negative'}"
    )

agent = Agent('openai:gpt-4', output_type=SentimentAnalysis)

review = "è¿™å®¶é¤å…çš„èœå“å¾ˆç¾å‘³ï¼ŒæœåŠ¡ä¹Ÿå¾ˆå‘¨åˆ°ï¼Œä½†æ˜¯ä»·æ ¼æœ‰ç‚¹è´µã€‚"
result = agent.run_sync(f'åˆ†æä»¥ä¸‹è¯„è®ºçš„æƒ…æ„Ÿï¼š{review}')

analysis = result.data
print(f"æ•´ä½“æƒ…æ„Ÿï¼š{analysis.sentiment}")
print(f"ç½®ä¿¡åº¦ï¼š{analysis.score}")
print(f"å„æ–¹é¢åˆ†æï¼š{analysis.aspects}")
```

### ç¤ºä¾‹ 3: æ•°æ®æå–

```python
from datetime import date

class Event(BaseModel):
    title: str
    date: date
    location: str
    participants: list[str]
    description: str

agent = Agent('openai:gpt-4', output_type=list[Event])

text = """
ä¸‹å‘¨ä¸€ï¼ˆ12æœˆ15æ—¥ï¼‰ä¸‹åˆ3ç‚¹åœ¨ä¼šè®®å®¤Aå¬å¼€é¡¹ç›®è¯„å®¡ä¼šï¼Œ
å‚ä¼šäººå‘˜åŒ…æ‹¬å¼ ä¸‰ã€æå››ã€ç‹äº”ã€‚ä¼šè®®ä¸»è¦è®¨è®ºQ4é¡¹ç›®è¿›å±•ã€‚

12æœˆ20æ—¥ä¸Šåˆ10ç‚¹åœ¨åŸ¹è®­ä¸­å¿ƒä¸¾åŠæŠ€æœ¯åˆ†äº«ä¼šï¼Œ
ä¸»è®²äººä¸ºèµµå…­ï¼Œä¸»é¢˜æ˜¯å¾®æœåŠ¡æ¶æ„æœ€ä½³å®è·µã€‚
"""

result = agent.run_sync(f'ä»ä»¥ä¸‹æ–‡æœ¬æå–æ‰€æœ‰äº‹ä»¶ä¿¡æ¯ï¼š\n{text}')

for event in result.data:
    print(f"{event.date} - {event.title}")
    print(f"  åœ°ç‚¹ï¼š{event.location}")
    print(f"  å‚ä¸è€…ï¼š{', '.join(event.participants)}")
    print()
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æè¿°æ€§å­—æ®µ

```python
# âœ… å¥½çš„åšæ³•
class Product(BaseModel):
    name: str = Field(description="äº§å“åç§°ï¼Œå¦‚ 'iPhone 15 Pro'")
    price: float = Field(description="ä»·æ ¼ï¼ˆå…ƒï¼‰ï¼Œå¿…é¡»å¤§äº0", gt=0)
    category: str = Field(description="äº§å“ç±»åˆ«ï¼Œå¦‚ 'ç”µå­äº§å“'ã€'æœè£…'")

# âŒ å·®çš„åšæ³•
class Product(BaseModel):
    name: str
    price: float
    category: str
```

### 2. æ·»åŠ åˆç†çš„çº¦æŸ

```python
class UserProfile(BaseModel):
    username: str = Field(min_length=3, max_length=20)
    age: int = Field(ge=0, le=150)
    email: str = Field(pattern=r'^[\w\.-]+@[\w\.-]+\.\w+$')
    bio: str = Field(max_length=500)
```

### 3. ä½¿ç”¨ç±»å‹æç¤º

```python
from typing import Literal

class OrderStatus(BaseModel):
    order_id: str
    status: Literal['pending', 'processing', 'shipped', 'delivered']
    tracking_number: Optional[str] = None
```

### 4. æä¾›é»˜è®¤å€¼

```python
class Config(BaseModel):
    debug: bool = False
    timeout: int = 30
    retries: int = 3
    tags: list[str] = []
```

## ğŸ”§ æ•…éšœæ’é™¤

### éªŒè¯å¤±è´¥

```python
from pydantic import ValidationError

try:
    result = agent.run_sync('æå–ä¿¡æ¯...')
except ValidationError as e:
    print("LLM è¾“å‡ºæ ¼å¼ä¸æ­£ç¡®ï¼š")
    print(e.errors())
    # å¯ä»¥é€‰æ‹©é‡è¯•æˆ–ä½¿ç”¨æ›´å®½æ¾çš„æ¨¡å‹
```

### ä½¿ç”¨ ModelRetry é‡è¯•

```python
@agent.output_validator
def validate_output(ctx: RunContext[None], output: MyModel) -> MyModel:
    if not output.is_valid():
        # è¦æ±‚ LLM é‡æ–°ç”Ÿæˆ
        raise ModelRetry('è¾“å‡ºä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·æŒ‰ç…§è§„èŒƒé‡æ–°ç”Ÿæˆ')
    return output
```

## ğŸ“š ä¸‹ä¸€æ­¥

- [08_æµå¼ä¼ è¾“.md](./08_æµå¼ä¼ è¾“.md) - æµå¼ç»“æ„åŒ–è¾“å‡º
- [13_æµ‹è¯•ä¸è¯„ä¼°.md](./13_æµ‹è¯•ä¸è¯„ä¼°.md) - éªŒè¯è¾“å‡ºè´¨é‡

## ğŸ”— å‚è€ƒèµ„æº

- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)
- [å®˜æ–¹æ–‡æ¡£ - Structured Outputs](https://ai.pydantic.dev/results/)
