# Pydantic AI å¿«é€Ÿå¼€å§‹

> æœ¬æ–‡æ¡£å°†å¸®åŠ©ä½ å¿«é€Ÿå®‰è£…å’Œå¼€å§‹ä½¿ç”¨ Pydantic AIï¼ŒåŒ…æ‹¬ç¯å¢ƒé…ç½®ã€ç¬¬ä¸€ä¸ª Agent å’Œå¸¸è§é—®é¢˜è§£å†³ã€‚

## ğŸ“¦ å®‰è£…

### ç³»ç»Ÿè¦æ±‚

- **Python ç‰ˆæœ¬**: 3.10 æˆ–æ›´é«˜
- **åŒ…ç®¡ç†å™¨**: pip æˆ– uvï¼ˆæ¨èï¼‰

### åŸºç¡€å®‰è£…

Pydantic AI æä¾›ä¸¤ç§å®‰è£…æ–¹å¼ï¼š

#### 1. æ ‡å‡†å®‰è£…ï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
# ä½¿ç”¨ pip
pip install pydantic-ai

# ä½¿ç”¨ uvï¼ˆæ¨èï¼‰
uv add pydantic-ai
```

**æ ‡å‡†å®‰è£…åŒ…å«**:
- `pydantic_ai` æ ¸å¿ƒåŒ…
- æ‰€æœ‰ä¸»æµæ¨¡å‹æä¾›å•†çš„ SDK
- Pydantic Logfireï¼ˆå¯è§‚æµ‹æ€§ï¼Œå¯é€‰ä½¿ç”¨ï¼‰
- æ ¸å¿ƒä¾èµ–é¡¹

#### 2. ç²¾ç®€å®‰è£…ï¼ˆä»…å®‰è£…éœ€è¦çš„æ¨¡å‹ï¼‰

```bash
# ä»…ä½¿ç”¨ OpenAI
pip install "pydantic-ai-slim[openai]"

# ä»…ä½¿ç”¨ Anthropic
pip install "pydantic-ai-slim[anthropic]"

# ä½¿ç”¨å¤šä¸ªæä¾›å•†
pip install "pydantic-ai-slim[openai,anthropic,google]"

# ä½¿ç”¨ uv
uv add "pydantic-ai-slim[openai]"
```

**å¯ç”¨çš„å¯é€‰ç»„**:
- `openai` - OpenAI (GPT-4, GPT-3.5, etc.)
- `anthropic` - Anthropic (Claude 3.5, etc.)
- `google` - Google (Gemini Pro, Flash, etc.)
- `groq` - Groq
- `mistral` - Mistral AI
- `cohere` - Cohere
- `bedrock` - Amazon Bedrock
- `vertexai` - Google Vertex AI
- `huggingface` - HuggingFace
- `logfire` - Pydantic Logfire å¯è§‚æµ‹æ€§
- `evals` - è¯„ä¼°å·¥å…·
- `cli` - å‘½ä»¤è¡Œå·¥å…·
- `mcp` - Model Context Protocol
- `examples` - è¿è¡Œå®˜æ–¹ç¤ºä¾‹æ‰€éœ€çš„ä¾èµ–

### å®‰è£…ç¤ºä¾‹ä¾èµ–

å¦‚æœä½ æƒ³è¿è¡Œå®˜æ–¹ç¤ºä¾‹ä»£ç ï¼š

```bash
pip install "pydantic-ai[examples]"

# æˆ–
uv add "pydantic-ai[examples]"
```

## ğŸ”‘ API å¯†é’¥é…ç½®

### è·å– API å¯†é’¥

ä½¿ç”¨ Pydantic AI éœ€è¦è‡³å°‘ä¸€ä¸ª LLM æä¾›å•†çš„ API å¯†é’¥ã€‚ä»¥ä¸‹æ˜¯ä¸»æµæä¾›å•†ï¼š

#### OpenAI
1. è®¿é—® [OpenAI Platform](https://platform.openai.com/)
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. å¯¼èˆªåˆ° **API Keys** é¡µé¢
4. ç‚¹å‡» **Create new secret key**

#### Anthropic
1. è®¿é—® [Anthropic Console](https://console.anthropic.com/)
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. å¯¼èˆªåˆ° **API Keys**
4. ç‚¹å‡» **Create Key**

#### Google Gemini
1. è®¿é—® [Google AI Studio](https://aistudio.google.com/)
2. ç™»å½• Google è´¦å·
3. ç‚¹å‡» **Get API Key**

#### Groqï¼ˆå…è´¹ä¸”å¿«é€Ÿï¼‰
1. è®¿é—® [Groq Console](https://console.groq.com/)
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. åˆ›å»º API Key

### é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆæ¨èï¼‰ï¼š

```bash
# .env
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GOOGLE_API_KEY=...
GROQ_API_KEY=gsk_...
```

æˆ–è€…åœ¨ shell ä¸­è®¾ç½®ï¼š

```bash
# Linux/macOS
export OPENAI_API_KEY='sk-...'

# Windows PowerShell
$env:OPENAI_API_KEY='sk-...'
```

### åœ¨ä»£ç ä¸­åŠ è½½ç¯å¢ƒå˜é‡

```python
from dotenv import load_dotenv
import os

# åŠ è½½ .env æ–‡ä»¶
load_dotenv()

# éªŒè¯ API å¯†é’¥
api_key = os.getenv('OPENAI_API_KEY')
if not api_key:
    raise ValueError("æœªæ‰¾åˆ° OPENAI_API_KEY ç¯å¢ƒå˜é‡")
```

## ğŸ¯ ç¬¬ä¸€ä¸ª Agent

### ç¤ºä¾‹ 1: æœ€ç®€å•çš„ Agent

```python
"""æœ€ç®€å•çš„ Pydantic AI Agent"""
from pydantic_ai import Agent

# åˆ›å»º Agent
agent = Agent(
    'openai:gpt-4',  # æŒ‡å®šæ¨¡å‹
    system_prompt='ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ã€‚'  # ç³»ç»Ÿæç¤º
)

# åŒæ­¥è¿è¡Œ
result = agent.run_sync('ä½ å¥½ï¼')
print(result.data)
# è¾“å‡º: ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ

# å¼‚æ­¥è¿è¡Œ
import asyncio

async def main():
    result = await agent.run('è§£é‡Šä»€ä¹ˆæ˜¯é€’å½’')
    print(result.data)

asyncio.run(main())
```

**å…³é”®ç‚¹**:
- `Agent()` åˆ›å»ºä¸€ä¸ª Agent å®ä¾‹
- ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¨¡å‹åç§°ï¼Œæ ¼å¼ä¸º `provider:model`
- `system_prompt` å®šä¹‰ Agent çš„è§’è‰²å’Œè¡Œä¸º
- `run_sync()` ç”¨äºåŒæ­¥æ‰§è¡Œ
- `run()` ç”¨äºå¼‚æ­¥æ‰§è¡Œ

### ç¤ºä¾‹ 2: ç»“æ„åŒ–è¾“å‡º

```python
"""ä½¿ç”¨ Pydantic æ¨¡å‹å®šä¹‰ç»“æ„åŒ–è¾“å‡º"""
from pydantic_ai import Agent
from pydantic import BaseModel, Field


class CityInfo(BaseModel):
    """åŸå¸‚ä¿¡æ¯"""
    city: str = Field(description="åŸå¸‚åç§°")
    country: str = Field(description="å›½å®¶åç§°")
    population: int = Field(description="äººå£æ•°é‡")
    famous_for: list[str] = Field(description="è‘—åæ™¯ç‚¹æˆ–ç‰¹è‰²")


# åˆ›å»ºå¸¦ç»“æ„åŒ–è¾“å‡ºçš„ Agent
agent = Agent(
    'openai:gpt-4',
    output_type=CityInfo,
    system_prompt='æå–ç”¨æˆ·è¯¢é—®çš„åŸå¸‚ä¿¡æ¯ã€‚'
)

# è¿è¡Œ
result = agent.run_sync('å‘Šè¯‰æˆ‘å…³äºå·´é»çš„ä¿¡æ¯')

# result.data æ˜¯ä¸€ä¸ª CityInfo å®ä¾‹
print(f"åŸå¸‚: {result.data.city}")
print(f"å›½å®¶: {result.data.country}")
print(f"äººå£: {result.data.population:,}")
print(f"è‘—åæ™¯ç‚¹: {', '.join(result.data.famous_for)}")

# è¾“å‡º:
# åŸå¸‚: Paris
# å›½å®¶: France
# äººå£: 2,161,000
# è‘—åæ™¯ç‚¹: Eiffel Tower, Louvre Museum, Notre-Dame Cathedral
```

**å…³é”®ç‚¹**:
- `output_type` å‚æ•°æŒ‡å®šè¾“å‡ºçš„ Pydantic æ¨¡å‹
- LLM ä¼šè‡ªåŠ¨ç”Ÿæˆç¬¦åˆæ¨¡å‹ç»“æ„çš„ JSON
- Pydantic AI è‡ªåŠ¨éªŒè¯å’Œè§£æè¾“å‡º
- `result.data` æ˜¯ç±»å‹å®‰å…¨çš„ Pydantic æ¨¡å‹å®ä¾‹

### ç¤ºä¾‹ 3: æ·»åŠ å·¥å…·

```python
"""ç»™ Agent æ·»åŠ å·¥å…·å‡½æ•°"""
from pydantic_ai import Agent, RunContext
import random


# åˆ›å»º Agent
agent = Agent(
    'openai:gpt-4',
    system_prompt='ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆåŠ©æ‰‹ï¼Œå¯ä»¥æ·éª°å­ã€‚'
)


@agent.tool
def roll_dice(ctx: RunContext[None], sides: int = 6) -> int:
    """
    æ·éª°å­ã€‚

    Args:
        sides: éª°å­çš„é¢æ•°ï¼Œé»˜è®¤ä¸º 6

    Returns:
        éª°å­ç»“æœ
    """
    return random.randint(1, sides)


# è¿è¡Œ
result = agent.run_sync('å¸®æˆ‘æ·ä¸€ä¸ª 20 é¢çš„éª°å­')
print(result.data)
# è¾“å‡º: æˆ‘ä¸ºä½ æ·äº†ä¸€ä¸ª 20 é¢çš„éª°å­ï¼Œç»“æœæ˜¯ 17ï¼

# æŸ¥çœ‹å·¥å…·è°ƒç”¨
for message in result.all_messages():
    if message.parts:
        for part in message.parts:
            if hasattr(part, 'tool_name'):
                print(f"è°ƒç”¨å·¥å…·: {part.tool_name}")
                print(f"å‚æ•°: {part.args}")
                print(f"ç»“æœ: {part.content}")
```

**å…³é”®ç‚¹**:
- `@agent.tool` è£…é¥°å™¨æ³¨å†Œå·¥å…·å‡½æ•°
- ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯ `RunContext`
- æ–‡æ¡£å­—ç¬¦ä¸²ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå·¥å…·æè¿°
- LLM å¯ä»¥è‡ªä¸»å†³å®šä½•æ—¶è°ƒç”¨å·¥å…·

### ç¤ºä¾‹ 4: ä¾èµ–æ³¨å…¥

```python
"""ä½¿ç”¨ä¾èµ–æ³¨å…¥ä¼ é€’ä¸Šä¸‹æ–‡"""
from pydantic_ai import Agent, RunContext
from dataclasses import dataclass
import httpx


@dataclass
class MyDeps:
    """ä¾èµ–å®¹å™¨"""
    api_key: str
    http_client: httpx.AsyncClient


# åˆ›å»º Agentï¼ŒæŒ‡å®šä¾èµ–ç±»å‹
agent = Agent(
    'openai:gpt-4',
    deps_type=MyDeps,
    system_prompt='ä½ æ˜¯ä¸€ä¸ªå¤©æ°”åŠ©æ‰‹ã€‚'
)


@agent.tool
async def get_weather(ctx: RunContext[MyDeps], city: str) -> str:
    """
    è·å–åŸå¸‚å¤©æ°”ã€‚

    Args:
        city: åŸå¸‚åç§°

    Returns:
        å¤©æ°”ä¿¡æ¯
    """
    # é€šè¿‡ ctx.deps è®¿é—®ä¾èµ–
    response = await ctx.deps.http_client.get(
        f'https://api.weather.com/v1/current',
        params={'city': city, 'key': ctx.deps.api_key}
    )
    return response.json()['weather']


# è¿è¡Œæ—¶æä¾›ä¾èµ–
async def main():
    async with httpx.AsyncClient() as client:
        deps = MyDeps(
            api_key='your-weather-api-key',
            http_client=client
        )

        result = await agent.run(
            'åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ',
            deps=deps
        )
        print(result.data)


import asyncio
asyncio.run(main())
```

**å…³é”®ç‚¹**:
- `deps_type` å‚æ•°æŒ‡å®šä¾èµ–ç±»å‹
- `RunContext[MyDeps]` æä¾›ç±»å‹å®‰å…¨çš„ä¾èµ–è®¿é—®
- é€šè¿‡ `ctx.deps` è®¿é—®ä¾èµ–å¯¹è±¡
- è¿è¡Œæ—¶é€šè¿‡ `deps` å‚æ•°ä¼ é€’ä¾èµ–å®ä¾‹

## ğŸ”§ å¸¸è§é—®é¢˜

### 1. æ¨¡å—å¯¼å…¥é”™è¯¯

**é—®é¢˜**: `ModuleNotFoundError: No module named 'pydantic_ai'`

**è§£å†³**:
```bash
# ç¡®ä¿åœ¨æ­£ç¡®çš„è™šæ‹Ÿç¯å¢ƒä¸­
which python

# é‡æ–°å®‰è£…
pip install --upgrade pydantic-ai
```

### 2. API å¯†é’¥é”™è¯¯

**é—®é¢˜**: `AuthenticationError: Invalid API key`

**è§£å†³**:
```python
import os
print(os.getenv('OPENAI_API_KEY'))  # æ£€æŸ¥æ˜¯å¦æ­£ç¡®åŠ è½½

# ç¡®ä¿ .env æ–‡ä»¶åœ¨æ­£ç¡®ä½ç½®
from dotenv import load_dotenv
load_dotenv()  # é»˜è®¤åŠ è½½å½“å‰ç›®å½•çš„ .env
```

### 3. æ¨¡å‹åç§°é”™è¯¯

**é—®é¢˜**: `ValueError: Unknown model: gpt4`

**è§£å†³**:
```python
# æ­£ç¡®çš„æ ¼å¼: provider:model
agent = Agent('openai:gpt-4')  # âœ… æ­£ç¡®
agent = Agent('gpt-4')         # âŒ é”™è¯¯
agent = Agent('openai:gpt4')   # âŒ é”™è¯¯ï¼ˆæ¨¡å‹åç§°é”™è¯¯ï¼‰
```

**å¸¸ç”¨æ¨¡å‹åç§°**:
- OpenAI: `openai:gpt-4`, `openai:gpt-3.5-turbo`
- Anthropic: `anthropic:claude-3-5-sonnet-20241022`
- Google: `google:gemini-1.5-pro`, `google:gemini-1.5-flash`
- Groq: `groq:llama3-70b-8192`

### 4. å¼‚æ­¥/åŒæ­¥æ··ç”¨

**é—®é¢˜**: `RuntimeError: This event loop is already running`

**è§£å†³**:
```python
# âœ… æ­£ç¡®ï¼šåœ¨åŒæ­¥ä»£ç ä¸­ä½¿ç”¨ run_sync()
result = agent.run_sync('hello')

# âœ… æ­£ç¡®ï¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨ run()
async def main():
    result = await agent.run('hello')

# âŒ é”™è¯¯ï¼šåœ¨åŒæ­¥ä»£ç ä¸­ç›´æ¥è°ƒç”¨ run()
result = agent.run('hello')  # è¿”å›åç¨‹ï¼Œä¸ä¼šæ‰§è¡Œ
```

### 5. ä¾èµ–ç±»å‹ä¸åŒ¹é…

**é—®é¢˜**: `TypeError: deps must be of type MyDeps`

**è§£å†³**:
```python
# ç¡®ä¿ä¾èµ–ç±»å‹åŒ¹é…
agent = Agent('openai:gpt-4', deps_type=MyDeps)

# âœ… æ­£ç¡®
result = agent.run_sync('hello', deps=MyDeps(...))

# âŒ é”™è¯¯
result = agent.run_sync('hello', deps={'key': 'value'})
```

## ğŸ“ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æŒæ¡äº† Pydantic AI çš„åŸºç¡€ä½¿ç”¨ï¼å»ºè®®ç»§ç»­å­¦ä¹ ï¼š

1. [02_æ ¸å¿ƒæ¦‚å¿µ.md](./02_æ ¸å¿ƒæ¦‚å¿µ.md) - æ·±å…¥ç†è§£æ ¸å¿ƒæ¦‚å¿µ
2. [03_Agentç³»ç»Ÿ.md](./03_Agentç³»ç»Ÿ.md) - Agent çš„é«˜çº§é…ç½®
3. [04_å·¥å…·ç³»ç»Ÿ.md](./04_å·¥å…·ç³»ç»Ÿ.md) - å·¥å…·çš„é«˜çº§ç”¨æ³•

## ğŸ“š å‚è€ƒèµ„æº

- [å®˜æ–¹æ–‡æ¡£ - Installation](https://ai.pydantic.dev/install/)
- [å®˜æ–¹æ–‡æ¡£ - Getting Started](https://ai.pydantic.dev/)
- [GitHub Examples](https://github.com/pydantic/pydantic-ai/tree/main/examples)
- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)
