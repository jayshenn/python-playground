# Pydantic AI ä¾èµ–æ³¨å…¥ç³»ç»Ÿ

> æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» Pydantic AI çš„ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œå¸®åŠ©ä½ æ„å»ºæ¨¡å—åŒ–ã€å¯æµ‹è¯•çš„ Agent åº”ç”¨ã€‚

## ğŸ¯ ä¾èµ–æ³¨å…¥æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ

**ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰** æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå…è®¸åœ¨è¿è¡Œæ—¶å°†ä¾èµ–å¯¹è±¡ä¼ é€’ç»™éœ€è¦å®ƒä»¬çš„ç»„ä»¶ã€‚

åœ¨ Pydantic AI ä¸­ï¼Œä¾èµ–æ³¨å…¥é€šè¿‡ `RunContext` å®ç°ï¼Œè®©ä½ å¯ä»¥ï¼š
- ä¼ é€’æ•°æ®åº“è¿æ¥
- æä¾› API å¯†é’¥
- å…±äº« HTTP å®¢æˆ·ç«¯
- æ³¨å…¥é…ç½®å¯¹è±¡
- ä¼ é€’ç”¨æˆ·ä¸Šä¸‹æ–‡

### æ ¸å¿ƒç»„ä»¶

```python
from pydantic_ai import Agent, RunContext
from dataclasses import dataclass


# 1. å®šä¹‰ä¾èµ–ç±»å‹
@dataclass
class MyDeps:
    database_url: str
    api_key: str


# 2. åˆ›å»º Agent æ—¶æŒ‡å®šä¾èµ–ç±»å‹
agent = Agent('openai:gpt-4', deps_type=MyDeps)


# 3. åœ¨å·¥å…·ä¸­è®¿é—®ä¾èµ–
@agent.tool
def query_database(ctx: RunContext[MyDeps], query: str) -> list:
    # é€šè¿‡ ctx.deps è®¿é—®ä¾èµ–
    db_url = ctx.deps.database_url
    return execute_query(db_url, query)


# 4. è¿è¡Œæ—¶æä¾›ä¾èµ–å®ä¾‹
deps = MyDeps(
    database_url='postgres://localhost/mydb',
    api_key='sk-...'
)

result = agent.run_sync('æŸ¥è¯¢ç”¨æˆ·æ•°æ®', deps=deps)
```

## ğŸ“¦ å®šä¹‰ä¾èµ–

### ä½¿ç”¨ DataClassï¼ˆæ¨èï¼‰

```python
from dataclasses import dataclass
import httpx


@dataclass
class APIDeps:
    """API ä¾èµ–"""
    api_key: str
    base_url: str
    http_client: httpx.AsyncClient
    timeout: int = 30
```

### ä½¿ç”¨ Pydantic BaseModel

```python
from pydantic import BaseModel, Field


class APIDeps(BaseModel):
    """API ä¾èµ–"""
    api_key: str = Field(..., description="API å¯†é’¥")
    base_url: str = Field(..., description="API åŸºç¡€ URL")
    timeout: int = Field(30, description="è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰")

    class Config:
        frozen = True  # ä¸å¯å˜
```

### ä½¿ç”¨ TypedDict

```python
from typing import TypedDict


class APIDeps(TypedDict):
    api_key: str
    base_url: str
    timeout: int
```

### ä½¿ç”¨æ™®é€šç±»

```python
class APIDeps:
    def __init__(self, api_key: str, base_url: str):
        self.api_key = api_key
        self.base_url = base_url
        self._client = None

    async def get_client(self) -> httpx.AsyncClient:
        if self._client is None:
            self._client = httpx.AsyncClient(base_url=self.base_url)
        return self._client
```

## ğŸ”§ è®¿é—®ä¾èµ–

### åœ¨å·¥å…·ä¸­è®¿é—®

```python
@agent.tool
async def fetch_user_data(ctx: RunContext[APIDeps], user_id: int) -> dict:
    """è·å–ç”¨æˆ·æ•°æ®"""
    # è®¿é—®ä¾èµ–
    client = await ctx.deps.get_client()

    response = await client.get(
        f'/users/{user_id}',
        headers={'Authorization': f'Bearer {ctx.deps.api_key}'}
    )

    return response.json()
```

### åœ¨ç³»ç»Ÿæç¤ºä¸­è®¿é—®

```python
@agent.system_prompt
def get_system_prompt(ctx: RunContext[APIDeps]) -> str:
    """åŠ¨æ€ç³»ç»Ÿæç¤º"""
    return f'ä½ æ˜¯ä¸€ä¸ªè¿æ¥åˆ° {ctx.deps.base_url} çš„ API åŠ©æ‰‹ã€‚'
```

### åœ¨éªŒè¯å™¨ä¸­è®¿é—®

```python
from pydantic import BaseModel


class UserData(BaseModel):
    user_id: int
    name: str


agent = Agent('openai:gpt-4', deps_type=APIDeps, output_type=UserData)


@agent.output_validator
async def validate_user(ctx: RunContext[APIDeps], output: UserData) -> UserData:
    """éªŒè¯ç”¨æˆ·æ•°æ®"""
    # ä»æ•°æ®åº“éªŒè¯
    is_valid = await verify_user_exists(
        ctx.deps.base_url,
        output.user_id
    )

    if not is_valid:
        from pydantic_ai import ModelRetry
        raise ModelRetry('ç”¨æˆ· ID æ— æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆã€‚')

    return output
```

## ğŸ§ª æµ‹è¯•å’Œè¦†ç›–

### ä½¿ç”¨ override() è¿›è¡Œæµ‹è¯•

```python
import pytest
from unittest.mock import AsyncMock


@dataclass
class ProductionDeps:
    database: Database
    api_client: httpx.AsyncClient


agent = Agent('openai:gpt-4', deps_type=ProductionDeps)


@agent.tool
async def get_user(ctx: RunContext[ProductionDeps], user_id: int) -> dict:
    """è·å–ç”¨æˆ·ä¿¡æ¯"""
    return await ctx.deps.database.query('users', user_id)


# æµ‹è¯•
@pytest.mark.asyncio
async def test_get_user():
    # åˆ›å»ºæµ‹è¯•ä¾èµ–
    mock_db = AsyncMock()
    mock_db.query.return_value = {'id': 1, 'name': 'Test User'}

    test_deps = ProductionDeps(
        database=mock_db,
        api_client=AsyncMock()
    )

    # ä½¿ç”¨ override() è¦†ç›–ä¾èµ–
    with agent.override(deps=test_deps):
        result = await agent.run('è·å–ç”¨æˆ· 1 çš„ä¿¡æ¯')

        # éªŒè¯
        mock_db.query.assert_called_once_with('users', 1)
        assert 'Test User' in result.data
```

### åˆ›å»ºæµ‹è¯•å·¥å‚

```python
def create_test_deps(**overrides) -> APIDeps:
    """åˆ›å»ºæµ‹è¯•ä¾èµ–"""
    defaults = {
        'api_key': 'test-key',
        'base_url': 'http://test-api.com',
        'timeout': 10
    }
    defaults.update(overrides)
    return APIDeps(**defaults)


# ä½¿ç”¨
test_deps = create_test_deps(api_key='custom-test-key')
```

## ğŸ¨ é«˜çº§æ¨¡å¼

### ä¾èµ–å·¥å‚

```python
from typing import Protocol


class DatabaseProtocol(Protocol):
    async def query(self, sql: str) -> list: ...


@dataclass
class AppDeps:
    create_database: callable


agent = Agent('openai:gpt-4', deps_type=AppDeps)


@agent.tool
async def run_query(ctx: RunContext[AppDeps], sql: str) -> list:
    """æ‰§è¡ŒæŸ¥è¯¢"""
    # ä½¿ç”¨å·¥å‚åˆ›å»ºæ•°æ®åº“è¿æ¥
    db = ctx.deps.create_database()
    return await db.query(sql)


# ä½¿ç”¨
def create_db() -> DatabaseProtocol:
    return PostgresDatabase(url='...')


deps = AppDeps(create_database=create_db)
```

### åˆ†å±‚ä¾èµ–

```python
@dataclass
class AuthDeps:
    api_key: str
    secret: str


@dataclass
class DatabaseDeps:
    db_url: str
    pool_size: int


@dataclass
class AppDeps:
    """ç»„åˆå¤šä¸ªä¾èµ–å±‚"""
    auth: AuthDeps
    database: DatabaseDeps
    environment: str


agent = Agent('openai:gpt-4', deps_type=AppDeps)


@agent.tool
async def secure_query(ctx: RunContext[AppDeps], query: str) -> list:
    """å®‰å…¨æŸ¥è¯¢"""
    # è®¿é—®åµŒå¥—ä¾èµ–
    if ctx.deps.environment == 'production':
        # ä½¿ç”¨ç”Ÿäº§æ•°æ®åº“
        db = connect(ctx.deps.database.db_url)
    else:
        db = connect('sqlite:///:memory:')

    # ä½¿ç”¨è®¤è¯
    if not verify_auth(ctx.deps.auth.api_key):
        raise PermissionError("æœªæˆæƒ")

    return await db.query(query)
```

### ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¾èµ–

```python
from contextlib import asynccontextmanager


@dataclass
class SessionDeps:
    session_factory: callable


agent = Agent('openai:gpt-4', deps_type=SessionDeps)


@agent.tool
async def transactional_update(
    ctx: RunContext[SessionDeps],
    data: dict
) -> str:
    """äº‹åŠ¡æ›´æ–°"""
    async with ctx.deps.session_factory() as session:
        await session.execute('UPDATE ...', data)
        await session.commit()
    return "æ›´æ–°æˆåŠŸ"


# ä½¿ç”¨
@asynccontextmanager
async def create_session():
    session = DatabaseSession()
    try:
        yield session
    finally:
        await session.close()


deps = SessionDeps(session_factory=create_session)
```

## ğŸ”„ å¼‚æ­¥ vs åŒæ­¥ä¾èµ–

### å¼‚æ­¥ä¾èµ–ï¼ˆæ¨èï¼‰

```python
@dataclass
class AsyncDeps:
    http_client: httpx.AsyncClient


@agent.tool
async def fetch_data(ctx: RunContext[AsyncDeps], url: str) -> dict:
    """å¼‚æ­¥è·å–æ•°æ®"""
    response = await ctx.deps.http_client.get(url)
    return response.json()


# ä½¿ç”¨
async def main():
    async with httpx.AsyncClient() as client:
        deps = AsyncDeps(http_client=client)
        result = await agent.run('è·å–æ•°æ®', deps=deps)
```

### åŒæ­¥ä¾èµ–

```python
@dataclass
class SyncDeps:
    config: dict


@agent.tool
def get_config_value(ctx: RunContext[SyncDeps], key: str) -> str:
    """è·å–é…ç½®å€¼"""
    # åŒæ­¥è®¿é—®
    return ctx.deps.config.get(key, 'default')


# åœ¨å¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­è‡ªåŠ¨å¤„ç†
result = await agent.run('è·å–é…ç½®', deps=SyncDeps(config={...}))
```

**æ³¨æ„**: åŒæ­¥å‡½æ•°ä¼šåœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼ˆ`run_in_executor`ï¼‰ï¼Œä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ã€‚

## ğŸŒŸ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ä¸å¯å˜ä¾èµ–

```python
# âœ… å¥½çš„åšæ³•
@dataclass(frozen=True)
class ImmutableDeps:
    api_key: str
    db_url: str


# âŒ é¿å…å¯å˜ä¾èµ–
@dataclass
class MutableDeps:
    cache: dict  # å¯èƒ½å¯¼è‡´å¹¶å‘é—®é¢˜
```

### 2. ä¾èµ–æ¥å£è€Œéå®ç°

```python
# âœ… ä½¿ç”¨åè®®/æŠ½è±¡
from typing import Protocol


class StorageProtocol(Protocol):
    async def save(self, key: str, value: str) -> None: ...
    async def load(self, key: str) -> str: ...


@dataclass
class AppDeps:
    storage: StorageProtocol  # æ¥å£


# å¯ä»¥åˆ‡æ¢å®ç°
class RedisStorage:
    async def save(self, key: str, value: str) -> None: ...
    async def load(self, key: str) -> str: ...


class FileStorage:
    async def save(self, key: str, value: str) -> None: ...
    async def load(self, key: str) -> str: ...
```

### 3. ç¯å¢ƒç‰¹å®šçš„ä¾èµ–

```python
import os


def create_deps() -> AppDeps:
    """æ ¹æ®ç¯å¢ƒåˆ›å»ºä¾èµ–"""
    if os.getenv('ENVIRONMENT') == 'production':
        return AppDeps(
            database=ProductionDB(),
            cache=RedisCache(),
            api_key=os.getenv('PROD_API_KEY')
        )
    else:
        return AppDeps(
            database=SQLiteDB(':memory:'),
            cache=InMemoryCache(),
            api_key='test-key'
        )
```

### 4. ä¾èµ–éªŒè¯

```python
from pydantic import BaseModel, Field, field_validator


class ValidatedDeps(BaseModel):
    """å¸¦éªŒè¯çš„ä¾èµ–"""
    api_key: str = Field(..., min_length=10)
    timeout: int = Field(..., gt=0, le=300)
    base_url: str

    @field_validator('base_url')
    def validate_url(cls, v):
        if not v.startswith('https://'):
            raise ValueError('å¿…é¡»ä½¿ç”¨ HTTPS')
        return v
```

### 5. ä¾èµ–ç”Ÿå‘½å‘¨æœŸç®¡ç†

```python
class ManagedDeps:
    """ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸ"""

    def __init__(self, db_url: str):
        self.db_url = db_url
        self._pool = None

    async def __aenter__(self):
        self._pool = await create_pool(self.db_url)
        return self

    async def __aexit__(self, *args):
        if self._pool:
            await self._pool.close()

    async def get_connection(self):
        return await self._pool.acquire()


# ä½¿ç”¨
async def main():
    async with ManagedDeps('postgres://...') as deps:
        result = await agent.run('æŸ¥è¯¢æ•°æ®', deps=deps)
```

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹ ï¼š

1. [06_æ¨¡å‹æ”¯æŒ.md](./06_æ¨¡å‹æ”¯æŒ.md) - äº†è§£æ”¯æŒçš„æ¨¡å‹
2. [13_æµ‹è¯•ä¸è¯„ä¼°.md](./13_æµ‹è¯•ä¸è¯„ä¼°.md) - æµ‹è¯•ç­–ç•¥
3. [14_æœ€ä½³å®è·µ.md](./14_æœ€ä½³å®è·µ.md) - æ¶æ„è®¾è®¡

## ğŸ”— å‚è€ƒèµ„æº

- [å®˜æ–¹æ–‡æ¡£ - Dependencies](https://ai.pydantic.dev/dependencies/)
- [å®˜æ–¹æ–‡æ¡£ - Run Context](https://ai.pydantic.dev/api/run-context/)
- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)
